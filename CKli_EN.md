# CKli

## What is CKli ?

CKli is a tool for <u>multi-repositories</u> stacks. It allow to automate actions, on <u>Worlds</u>, a set of repositories, and concentrate information in a single place.

## Getting Started

### Prerequisites

- [.NET Core Runtime 2.1.](https://dotnet.microsoft.com/)



### Installation

CKli is a [dotnet tool](https://docs.microsoft.com/en-us/dotnet/core/tools/global-tools). You can install it globally by running :

```powershell
#latest stable
dotnet tool install CKli -g
```



### Run CKli

If you installed CKli globally, you can run `ckli` in any command prompt to start it.  



### First Run

CKli will ask a password to secure your [KeyVault](docs/KeyVault.md), where all your [secrets](docs/TODO.md) are stored. Every time you start CKli, your KeyVault password will be asked.

By default there is 2 stack available: CK and CK-Build.



### Commands

There is 4 <u>base commands</u> available, that allow you to:

- `run` a set of commands
- `list` a set of commands
- clear the prompt, with `cls`
- manage your `secret`

These <u>base commands</u> are available everywhere.

Different <u>commands</u> available, depending on the context.

The commands `run` and `list` works on a set of commands. You can <u>filter</u> those commands with wildcards and text.

For example, `list home*`  will return any command starting with `home` : 

```
Available Commands matching 'home*':
     Home/Close
     Home/DeleteStackDefinition
     Home/EnsureStackDefinition
     Home/SetWorldMapping
```

You can notice that the filtering is <u>case insensitive</u>.

 :warning: â€‹`run` will only work on a set of commands with the same payload (parameters).

`> run home*`

Results in :
```
> Warn: Pattern 'home*' matches require 4 different payloads.
|  - Warn: (stackName, url, isPublic, mappedPath, branchName): Home/EnsureStackDefinition
|          (stackName): Home/DeleteStackDefinition
|          (worldFullName, mappedPath): Home/SetWorldMapping
|          <No payload>: Home/Close, Home/Refresh
```



### Worlds And Stacks

A World is a group of repositories.

A Stack is a World, with zero or more [Parallel World](docs/ParallelWorlds.md).

The stacks are versioned in git repositories. [Stacks Location Directory](docs/TODO.md)

To add a Stack, use the command `Home/EnsureStackDefinition`  



#### Ensure Stack Definition Example

Lets Ensure the stack SC (for Signature-Code).

This is a private stack, if you don't have access to https://gitlab.com/signature-code/signature-code-stack.git you can't test this example.

Next we are asked somes informations (the parameters of the command:
```bash
> SC                                                        #stack's name
> https://gitlab.com/signature-code/signature-code-stack.git#Git URL containing the stack
> false                                                     #Whether the stack is public
> C:/dev/CK                                                 #local mapping
>                                                           #leave empty
> y                                                         #Confirm
```
The local mapping is the location where the Stack will be cloned on your PC.

Signature-Code being a private stack, CKli will not be able to clone the repository automatically.

Press `Enter` to see the Worlds list (We can see a the PAT asked in the warnings)


Create your PAT on GitLab: https://gitlab.com/profile/personal_access_tokens

Run `secret set GITLAB_GIT_WRITE_PAT`

* Name: GITLAB_GIT_WRITE_PAT
* check Write

> `secret set GITLAB_GIT_WRITE_PAT`

Paste the previously obtained token
``` bash
> MGI5YzI2MjVkYzIxZWYwNWY2YWQ0ZGRmNDdjNWYy
```

When pressing `Enter`, the repository will automaticly be cloned and the stacks defined inside will be displayed.
To open a World, simply enter it's index and CKli Will clone every repository inside the directory.



#### Commands to know

- `Home/Close` to close a World.


## Glossaire
A `world` is a set of repositories on a defined branch and are described by a xml file.

A `stack` is a set of at least one World targeting a same set of repositories but not the same branch.

A `PAT`([Personal Access Token](https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html)) is like a password generated by a service for a user allowing him to authenticate and do actions in his name.

